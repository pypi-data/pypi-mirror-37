
# PCA implements: fit, transform, fit_transform

from io import StringIO
import numpy as np

from .utils import parse_test_df
from ..ponder import use_dataframes

from sklearn.decomposition import PCA

random1 = """
Boolean,Float,Integer,Binary,Ordinal,Nominal,Nominal2
False,-91.70353154100944,-19,No,Small,Yellow,PositiveA
False,-100.7646044339111,-29,Yes,Large,Yellow,PositiveA
False,-47.31856770249317,-35,No,Medium,Green,PositiveA
False,-73.25058305886796,-36,Yes,Small,Red,PositiveA
True,-73.3503264846611,-20,No,Medium,Green,PositiveA
False,-64.410365287374,38,Yes,Medium,Green,Negative
True,-56.42366099770481,83,No,Large,Yellow,PositiveB
False,-90.07982302278825,40,Yes,Medium,Red,Negative
True,-85.87752953888797,-16,No,Small,Yellow,Negative
True,-72.7651790369317,77,No,Medium,Red,PositiveA
False,-72.58103656260525,33,No,Large,Green,PositiveB
True,-67.39009596421542,54,Yes,Large,Yellow,PositiveB
False,-50.69539480986763,-22,No,Medium,Yellow,PositiveA
False,-79.38723920885045,53,No,Small,Red,PositiveA
False,-75.319654916638,66,Yes,Small,Green,PositiveA
False,-86.78651562886694,53,Yes,Small,Red,PositiveB
False,-71.94628003068131,34,Yes,Small,Green,Negative
False,-102.62798417179903,65,No,Medium,Yellow,Negative
False,-67.68842323268751,58,No,Medium,Yellow,Negative
False,-74.1392350947031,-27,No,Large,Yellow,PositiveB
True,-98.23995635089136,36,No,Small,Green,PositiveA
False,-69.99687745910832,-10,No,Small,Red,PositiveA
False,-106.43248137769748,4,No,Small,Red,PositiveB
False,-118.60379759970355,60,No,Small,Green,Negative
True,-52.28409062737161,43,Yes,Large,Red,PositiveB
False,-29.69941718494491,-14,No,Medium,Green,Negative
False,-99.31554758322726,36,No,Small,Yellow,PositiveA
True,-89.3972793730313,-16,Yes,Medium,Yellow,PositiveA
False,-100.50202025661773,-33,No,Small,Green,PositiveA
False,-82.6927322447452,50,No,Small,Green,PositiveA
"""

random1_components = np.array([[0.0017494459238244808, 0.0009991535159368237, 8.180391918328339e-05, -0.0008274208295543169, 0.000745616910371066, 0.001413096684291239, -0.001213657055259356, -0.00019943962903188478, 0.0023380806503509686, -0.0045870857579795804, 0.002249005107628616, -0.0590591140130346, 0.9982342607518607], [0.0032091446524347544, 0.0013277574122445013, -0.012706603410726085, 0.008360674725376199, 0.004345928685349887, -1.778609309252457e-05, -0.0023975275046259096, 0.002415313597718422, 0.00020638237246615836, -0.0036472297320632257, 0.003440847359597053, 0.9981068760245653, 0.059021947035717726], [0.225859060277169, 0.1155988727379716, -0.30612747612785446, -0.12089226164882393, 0.4270197377766784, 0.003975218755905389, 0.4433771864763878, -0.44735240523229314, -0.13572129006169661, -0.2642218212532929, 0.3999431113149895, -0.00563909337187081, -0.0025925105209785027], [-0.014050091198133914, -0.1017131164885814, -0.3988686299802969, 0.5051294671153189, -0.1062608371350218, -0.3772024755454165, 0.3065288288375111, 0.07067364670790538, 0.463484016450403, -0.21786886697013694, -0.245615149480266, -0.008126830650246206, -0.00043623014950171235], [0.2822554090999524, -0.29417164785183525, -0.06463101368304076, 0.16187959130262855, -0.0972485776195878, -0.09885577940287528, 0.3106348626571955, -0.21177908325432016, -0.39400392633611747, 0.6497435865803902, -0.2557396602442728, 0.0020216290370271423, 0.00509151991332496], [-0.04013616083321452, 0.3592445595535686, -0.09485423005690397, 0.356079092893801, -0.26122486283689705, 0.6044230480915417, -0.10445831476009591, -0.49996473333144476, 0.11973720724954205, 0.033917599193567065, -0.1536548064431086, -0.0017583817495547827, -0.0007561470907632151], [0.41669674726042544, 0.5497490778889381, -0.36935672658060503, 0.1865826006728121, 0.18277412590779257, -0.08511242123876057, -0.30804885412414107, 0.39316127536290185, -0.1841961895293925, 0.16886194117092007, 0.015334248358472753, -0.010173146885356477, -0.0008366675464168694], [-0.20776295713468768, 0.6560074575335568, 0.28058587886613573, -0.2697242650834029, -0.010861613782732146, -0.3076968144353882, 0.38604995121435587, -0.07835313677896753, 0.10873498902926221, 0.17718427436281747, -0.28591926339207924, 0.008274808718272436, 0.0020515864883302593], [0.8061189342138674, -0.02230438645977338, 0.3681790452101147, -0.14994002325711706, -0.2182390219529975, 0.013769843987762565, 0.03153391598114305, -0.04530375996890553, 0.3001769482424142, -0.20295093297627678, -0.09722601526613732, 0.004198552145471022, -0.002540309583943995], [-0.02947086106846902, 0.1662156752685179, 0.2231857017623231, 0.337315556394106, -0.5605012581564297, -0.21715526918418845, 0.15423224867512944, 0.06292302050905878, -0.35775638117325, -0.15791603374611352, 0.5156724149193632, 0.000261202353338999, 3.867582062136443e-05]])

random1_transformed = np.array([[-38.34958244355476, -15.61979023856738, 0.1241077834457554, -0.10330948046487615, 0.5176658551082978, -0.1961635538105262, -0.6084482632499378, 0.36945409221192776, 0.0002124468954520553, 0.09479074421947015], [-47.79512314750394, -25.23554857798117, 1.0498752113904446, 0.16558530229698276, 0.12164331611975643, 0.020204669076945323, 0.593977968069977, 0.6385195472422296, -0.6211502979227552, -0.5254340722003805], [-56.94256226271039, 27.76267632742436, -0.7901973808407418, 0.2111040323602377, 0.2300281272725963, -0.2066840063472546, 0.2105531176027307, -0.31080743781305703, -0.3677467590278682, 0.12858601456272734], [-56.40575375736435, 1.7985589236016881, -0.2596805321572385, -1.0313019761069375, -0.23524725685986947, 0.8523695413011823, -0.009263959563273543, 0.44953243277198274, 0.08080491780930753, -0.10621863375231437], [-40.429886295632784, 2.668737242117886, -0.45643045997158727, 0.40206618407031625, 0.5360297756335061, -0.21238860399054083, 0.8795247574420657, -0.7032044221454391, 0.29097183474158406, 0.09289573414812341], [16.9458895143529, 15.017019137458902, -0.6389690024683453, 0.8978011428591851, -0.77076335411561, 0.21323532857691327, 0.5200447012686985, 0.2850851923687337, -0.1441266673168201, 0.09332025955750371], [61.39596360613353, 25.640879487444867, 1.2838964329147229, -0.1837070698450851, 0.4524782953190892, -0.7294052368082597, -0.23739575118148182, -0.09166389316557799, 0.21465103025559076, -0.03161850918748941], [20.459986003218546, -10.488232337699378, -0.04807393054681165, 0.6576638962062236, -0.6995511315601698, 1.3612475218212938, 0.3012368335840214, -0.15256516497335795, -0.19790823937614113, -0.19338560126392698], [-35.69028356545048, -9.620688982652938, 0.4378364740769159, 0.5153376896697882, -0.21677367415101567, -0.16299288345345547, -0.6065884234510381, 0.14760566136850306, 1.326299106781704, -0.13288267138075943], [56.36589124378114, 8.975472695958631, -0.2598760576123615, -0.09287965689779232, 1.144013462148744, 0.8176239970355276, 0.31414151790262457, -0.7287022272318789, 0.10609218112776576, -0.18327815905445427], [12.437755625681772, 6.564598182270467, 0.38804625643265567, -0.25239239833309923, -0.6394312749627823, -1.0185573056942099, 0.253322363269581, -0.5845825406295668, -0.6091276845543192, -0.09961101183749338], [33.09583713084918, 12.984896635270834, 1.5365188614937735, -0.1836471521883467, -0.011517493380137554, -0.32894923251976615, 0.44817983927656724, 0.4141024045371518, 0.21997247267338166, 0.13061110866201725], [-43.767098673225696, 25.15471444276975, 0.08587181745436774, 0.4687311245831141, 0.8118051403240479, 0.18493025120118156, -0.46718073181795766, 0.15232367614035874, -0.33811089236564323, 0.21951599320961054], [32.79852177125592, 0.9251457532723526, -0.5714076642414804, -0.9185417776343091, 0.4996636210148315, 0.43661847484711, -0.571047344684615, -0.07466348311109641, -0.14874331954646158, -0.2705950700135385], [45.53472585376132, 5.756075772706494, -0.9637765398861687, -0.611106332511503, 0.16698157470046804, -0.32550702518643165, 0.40471861922932034, 0.871016758390682, -0.2460673697972222, 0.17726414320583506], [33.24335172534118, -6.451707084648632, 0.25008135168152873, -0.9878685102331854, -0.7149498657253625, 0.621301381380871, -0.09955203374194171, 0.05701283963830359, -0.09638903618428889, 0.567276345506542], [13.39892614411169, 7.238215748750015, -0.7713384479834942, 0.056791069275128156, -1.0328748628202102, -0.2214223910599065, 0.04411601180013751, 0.7648307373468742, 0.35251370847258817, -0.0229326970222785], [46.15329989471294, -21.540797084922225, 0.2816766537757903, 1.5341793439701994, 0.10603142924472421, 0.2962823797018999, -0.3647110793407084, -0.1673698279230365, -0.2740316294354825, 0.00947552762020845], [37.10216055638155, 12.9194653044343, 0.10279678091481967, 1.2532850602705947, 0.14102562078693673, 0.24013832304445148, -0.7142996920592357, 0.10738725013022295, -0.10955389380515225, 0.0183310924177862], [-47.365288412093996, 1.4632198499268145, 1.4431133064144586, 0.022299808356430625, -0.4256586232487064, -0.5749421538160444, -0.3818359308888716, -0.25616843673426154, -0.38641361135764024, -0.011029338032257897], [16.94210101923208, -18.889611713208833, -0.6464913168184372, -0.3240869945272318, 0.5443266873356054, -0.6619006931140331, 0.5299379081406199, -0.24396236106106223, 0.5623331576331112, -0.02556950442365906], [-30.64482310131296, 6.579347720797821, -0.4610326281222747, -0.9673731579004051, 0.19788169445682677, 0.4677439008427287, -0.613866818647112, -0.12620998460140456, 0.050722107713138904, -0.27057886212494736], [-14.510852873959573, -28.953883746861912, 0.372300929709735, -0.705120679817737, -0.7099795484447265, 0.33365313689982196, -0.4084431065889178, -0.8620889644807406, -0.03209409175586248, 0.39403398254036537], [42.10756941981818, -37.79773048961163, -0.6912364961954877, 0.5263399457209958, -0.7006478895350654, -0.5182850476004184, -0.05273264275987545, -0.2239175046431905, 0.11287602525804745, -0.2003298543446253], [21.2257397248481, 27.415442755257065, 1.0404503349336134, -0.9853438721010005, -0.44647611546433236, 0.36168762423728357, 0.5266440040298422, -0.17721250782464004, 0.29357515721988736, -0.23725611908060062], [-37.013289039741686, 46.59178610855566, -0.8154956054911944, 0.7401082301839292, -0.6711780811700598, -0.1677246799100227, -0.33931723778255923, -0.19037830658051413, 0.1560095431348281, -0.06583997705234285], [17.002860821103976, -19.97118870374982, 0.024444574002182598, -0.06544057340540864, 0.7823107776799066, -0.22436681371654896, -0.5770268210116938, 0.4193033723603183, -0.1714640265068812, 0.09492963784976367], [-35.489245496339585, -13.115234070553896, 0.6300182280626827, 0.6648741976895977, 0.7521971674315505, 0.5675544548661993, 0.8879650444540789, 0.2926270036723694, 0.26796991741834414, 0.34638383900683506], [-51.80421692845707, -25.223116741638243, -0.6807111615705598, -0.26155361273160715, -0.0938166498591966, -0.565612811130001, 0.1939835299599759, -0.19647701774955617, -0.07800180855320028, 0.0006418686063568875], [29.997425942763222, -2.5487223159218604, -0.996317772797264, -0.44249378281419716, 0.36478327672035593, -0.6596885466759892, -0.056636379261021545, 0.1211731124887228, -0.2140742796289932, 0.008503789657923259]])

def test_fit():
    df = parse_test_df(StringIO(random1))
    pca = use_dataframes(PCA(10))
    pca.fit_df(df)
    assert np.all(np.isclose(pca.components_,random1_components))

def test_transform():
    df = parse_test_df(StringIO(random1))
    pca = use_dataframes(PCA(10))
    pca.fit_df(df)
    transformed = pca.transform_df(df)
    assert np.all(np.isclose(transformed,random1_transformed))
